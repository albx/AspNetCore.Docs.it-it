---
title: Memorizzare nella cache in memoria ASP.NET Core
author: rick-anderson
description: Informazioni su come memorizzare i dati nella cache in memoria in ASP.NET Core.
ms.author: riande
ms.custom: mvc
ms.date: 02/02/2020
no-loc:
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: performance/caching/memory
ms.openlocfilehash: 8eec361efbc3c7dca6c0bef65b6f6b40b3b46798
ms.sourcegitcommit: d65a027e78bf0b83727f975235a18863e685d902
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/26/2020
ms.locfileid: "85404613"
---
# <a name="cache-in-memory-in-aspnet-core"></a><span data-ttu-id="1b778-103">Memorizzare nella cache in memoria ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="1b778-103">Cache in-memory in ASP.NET Core</span></span>

::: moniker range=">= aspnetcore-3.0"

<span data-ttu-id="1b778-104">Di [Rick Anderson](https://twitter.com/RickAndMSFT), [John Luo](https://github.com/JunTaoLuo)e [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="1b778-104">By [Rick Anderson](https://twitter.com/RickAndMSFT), [John Luo](https://github.com/JunTaoLuo), and [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="1b778-105">[Visualizzare o scaricare il codice di esempio](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/memory/3.0sample) ([procedura per il download](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="1b778-105">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/memory/3.0sample) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="caching-basics"></a><span data-ttu-id="1b778-106">Nozioni fondamentali sulla memorizzazione nella cache</span><span class="sxs-lookup"><span data-stu-id="1b778-106">Caching basics</span></span>

<span data-ttu-id="1b778-107">La memorizzazione nella cache può migliorare significativamente le prestazioni e la scalabilità di un'app riducendo il lavoro necessario per generare il contenuto.</span><span class="sxs-lookup"><span data-stu-id="1b778-107">Caching can significantly improve the performance and scalability of an app by reducing the work required to generate content.</span></span> <span data-ttu-id="1b778-108">La memorizzazione nella cache funziona meglio con i dati che cambiano raramente **ed** è costoso da generare.</span><span class="sxs-lookup"><span data-stu-id="1b778-108">Caching works best with data that changes infrequently **and** is expensive to generate.</span></span> <span data-ttu-id="1b778-109">La memorizzazione nella cache crea una copia dei dati che possono essere restituiti molto più velocemente rispetto all'origine.</span><span class="sxs-lookup"><span data-stu-id="1b778-109">Caching makes a copy of data that can be returned much faster than from the source.</span></span> <span data-ttu-id="1b778-110">Le app devono essere scritte e testate in modo da non dipendere **mai** dai dati memorizzati nella cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-110">Apps should be written and tested to **never** depend on cached data.</span></span>

<span data-ttu-id="1b778-111">ASP.NET Core supporta diverse cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-111">ASP.NET Core supports several different caches.</span></span> <span data-ttu-id="1b778-112">La cache più semplice si basa su [IMemoryCache](/dotnet/api/microsoft.extensions.caching.memory.imemorycache).</span><span class="sxs-lookup"><span data-stu-id="1b778-112">The simplest cache is based on the [IMemoryCache](/dotnet/api/microsoft.extensions.caching.memory.imemorycache).</span></span> <span data-ttu-id="1b778-113">`IMemoryCache`rappresenta una cache archiviata nella memoria del server Web.</span><span class="sxs-lookup"><span data-stu-id="1b778-113">`IMemoryCache` represents a cache stored in the memory of the web server.</span></span> <span data-ttu-id="1b778-114">Le app in esecuzione in un server farm (più server) devono garantire che le sessioni siano permanenti quando si usa la cache in memoria.</span><span class="sxs-lookup"><span data-stu-id="1b778-114">Apps running on a server farm (multiple servers) should ensure sessions are sticky when using the in-memory cache.</span></span> <span data-ttu-id="1b778-115">Le sessioni permanenti garantiscono che le richieste successive provenienti da un client vadano tutte allo stesso server.</span><span class="sxs-lookup"><span data-stu-id="1b778-115">Sticky sessions ensure that subsequent requests from a client all go to the same server.</span></span> <span data-ttu-id="1b778-116">Ad esempio, le app Web di Azure usano [Application Request Routing](https://www.iis.net/learn/extensions/planning-for-arr) (arr) per indirizzare tutte le richieste successive allo stesso server.</span><span class="sxs-lookup"><span data-stu-id="1b778-116">For example, Azure Web apps use [Application Request Routing](https://www.iis.net/learn/extensions/planning-for-arr) (ARR) to route all subsequent requests to the same server.</span></span>

<span data-ttu-id="1b778-117">Le sessioni non permanenti in una Web farm richiedono una [cache distribuita](distributed.md) per evitare problemi di coerenza della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-117">Non-sticky sessions in a web farm require a [distributed cache](distributed.md) to avoid cache consistency problems.</span></span> <span data-ttu-id="1b778-118">Per alcune app, una cache distribuita può supportare una maggiore scalabilità orizzontale rispetto a una cache in memoria.</span><span class="sxs-lookup"><span data-stu-id="1b778-118">For some apps, a distributed cache can support higher scale-out than an in-memory cache.</span></span> <span data-ttu-id="1b778-119">L'uso di una cache distribuita trasferisce la memoria cache a un processo esterno.</span><span class="sxs-lookup"><span data-stu-id="1b778-119">Using a distributed cache offloads the cache memory to an external process.</span></span>

<span data-ttu-id="1b778-120">La cache in memoria può archiviare qualsiasi oggetto.</span><span class="sxs-lookup"><span data-stu-id="1b778-120">The in-memory cache can store any object.</span></span> <span data-ttu-id="1b778-121">L'interfaccia della cache distribuita è limitata a `byte[]` .</span><span class="sxs-lookup"><span data-stu-id="1b778-121">The distributed cache interface is limited to `byte[]`.</span></span> <span data-ttu-id="1b778-122">Gli elementi memorizzati nella cache in memoria e nella cache distribuita vengono archiviati come coppie chiave-valore.</span><span class="sxs-lookup"><span data-stu-id="1b778-122">The in-memory and distributed cache store cache items as key-value pairs.</span></span>

## <a name="systemruntimecachingmemorycache"></a><span data-ttu-id="1b778-123">System. Runtime. Caching/MemoryCache</span><span class="sxs-lookup"><span data-stu-id="1b778-123">System.Runtime.Caching/MemoryCache</span></span>

<span data-ttu-id="1b778-124"><xref:System.Runtime.Caching>/<xref:System.Runtime.Caching.MemoryCache>([Pacchetto NuGet](https://www.nuget.org/packages/System.Runtime.Caching/)) può essere usato con:</span><span class="sxs-lookup"><span data-stu-id="1b778-124"><xref:System.Runtime.Caching>/<xref:System.Runtime.Caching.MemoryCache> ([NuGet package](https://www.nuget.org/packages/System.Runtime.Caching/)) can be used with:</span></span>

* <span data-ttu-id="1b778-125">.NET Standard 2,0 o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="1b778-125">.NET Standard 2.0 or later.</span></span>
* <span data-ttu-id="1b778-126">Qualsiasi [implementazione di .NET](/dotnet/standard/net-standard#net-implementation-support) destinata a .NET standard 2,0 o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="1b778-126">Any [.NET implementation](/dotnet/standard/net-standard#net-implementation-support) that targets .NET Standard 2.0 or later.</span></span> <span data-ttu-id="1b778-127">Ad esempio, ASP.NET Core 2,0 o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="1b778-127">For example, ASP.NET Core 2.0 or later.</span></span>
* <span data-ttu-id="1b778-128">.NET Framework 4.5 o versioni successive.</span><span class="sxs-lookup"><span data-stu-id="1b778-128">.NET Framework 4.5 or later.</span></span>

<span data-ttu-id="1b778-129">È consigliabile usare [Microsoft. Extensions. Caching. memory](https://www.nuget.org/packages/Microsoft.Extensions.Caching.Memory/) / `IMemoryCache` (descritto in questo articolo) `System.Runtime.Caching` / `MemoryCache` perché è più integrato in ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="1b778-129">[Microsoft.Extensions.Caching.Memory](https://www.nuget.org/packages/Microsoft.Extensions.Caching.Memory/)/`IMemoryCache` (described in this article) is recommended over `System.Runtime.Caching`/`MemoryCache` because it's better integrated into ASP.NET Core.</span></span> <span data-ttu-id="1b778-130">Ad esempio, `IMemoryCache` funziona in modo nativo con ASP.NET Core [inserimento delle dipendenze](xref:fundamentals/dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="1b778-130">For example, `IMemoryCache` works natively with ASP.NET Core [dependency injection](xref:fundamentals/dependency-injection).</span></span>

<span data-ttu-id="1b778-131">Usare `System.Runtime.Caching` / `MemoryCache` come Bridge di compatibilità quando si porta il codice da ASP.NET 4. x a ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="1b778-131">Use `System.Runtime.Caching`/`MemoryCache` as a compatibility bridge when porting code from ASP.NET 4.x to ASP.NET Core.</span></span>

## <a name="cache-guidelines"></a><span data-ttu-id="1b778-132">Linee guida per la cache</span><span class="sxs-lookup"><span data-stu-id="1b778-132">Cache guidelines</span></span>

* <span data-ttu-id="1b778-133">Il codice deve sempre avere un'opzione di fallback per recuperare i dati e **non** dipendere da un valore memorizzato nella cache disponibile.</span><span class="sxs-lookup"><span data-stu-id="1b778-133">Code should always have a fallback option to fetch data and **not** depend on a cached value being available.</span></span>
* <span data-ttu-id="1b778-134">La cache usa una risorsa scarsa, ovvero la memoria.</span><span class="sxs-lookup"><span data-stu-id="1b778-134">The cache uses a scarce resource, memory.</span></span> <span data-ttu-id="1b778-135">Limita aumento dimensioni cache:</span><span class="sxs-lookup"><span data-stu-id="1b778-135">Limit cache growth:</span></span>
  * <span data-ttu-id="1b778-136">Non **usare input** esterno come chiavi di cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-136">Do **not** use external input as cache keys.</span></span>
  * <span data-ttu-id="1b778-137">Usare le scadenze per limitare la crescita della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-137">Use expirations to limit cache growth.</span></span>
  * <span data-ttu-id="1b778-138">[Per limitare le dimensioni della cache, usare le dimensioni, le dimensioni e il valore di SizeLimit](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span><span class="sxs-lookup"><span data-stu-id="1b778-138">[Use SetSize, Size, and SizeLimit to limit cache size](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span></span> <span data-ttu-id="1b778-139">Il runtime di ASP.NET Core **non limita le** dimensioni della cache in base all'utilizzo eccessivo della memoria.</span><span class="sxs-lookup"><span data-stu-id="1b778-139">The ASP.NET Core runtime does **not** limit cache size based on memory pressure.</span></span> <span data-ttu-id="1b778-140">Spetta allo sviluppatore limitare le dimensioni della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-140">It's up to the developer to limit cache size.</span></span>

## <a name="use-imemorycache"></a><span data-ttu-id="1b778-141">Usare IMemoryCache</span><span class="sxs-lookup"><span data-stu-id="1b778-141">Use IMemoryCache</span></span>

> [!WARNING]
> <span data-ttu-id="1b778-142">L'uso di una cache *Shared* Memory dall' [inserimento delle dipendenze](xref:fundamentals/dependency-injection) e della chiamata `SetSize` `Size` di, o `SizeLimit` per limitare le dimensioni della cache può causare un errore dell'app.</span><span class="sxs-lookup"><span data-stu-id="1b778-142">Using a *shared* memory cache from [Dependency Injection](xref:fundamentals/dependency-injection) and calling `SetSize`, `Size`, or `SizeLimit` to limit cache size can cause the app to fail.</span></span> <span data-ttu-id="1b778-143">Quando si imposta un limite di dimensioni in una cache, è necessario che tutte le voci specifichino una dimensione al momento dell'aggiunta.</span><span class="sxs-lookup"><span data-stu-id="1b778-143">When a size limit is set on a cache, all entries must specify a size when being added.</span></span> <span data-ttu-id="1b778-144">Questo può causare problemi perché gli sviluppatori potrebbero non avere il controllo completo su ciò che usa la cache condivisa.</span><span class="sxs-lookup"><span data-stu-id="1b778-144">This can lead to issues since developers may not have full control on what uses the shared cache.</span></span> <span data-ttu-id="1b778-145">Ad esempio, Entity Framework Core utilizza la cache condivisa e non specifica una dimensione.</span><span class="sxs-lookup"><span data-stu-id="1b778-145">For example, Entity Framework Core uses the shared cache and does not specify a size.</span></span> <span data-ttu-id="1b778-146">Se un'app imposta un limite per le dimensioni della cache e USA EF Core, l'app genera un'eccezione `InvalidOperationException` .</span><span class="sxs-lookup"><span data-stu-id="1b778-146">If an app sets a cache size limit and uses EF Core, the app throws an `InvalidOperationException`.</span></span>
> <span data-ttu-id="1b778-147">Quando `SetSize` si usa, `Size` o `SizeLimit` per limitare la cache, creare un singleton della cache per la memorizzazione nella cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-147">When using `SetSize`, `Size`, or `SizeLimit` to limit cache, create a cache singleton for caching.</span></span> <span data-ttu-id="1b778-148">Per altre informazioni e per un esempio, vedere [use sesize, Size e SizeLimit per limitare le dimensioni della cache](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span><span class="sxs-lookup"><span data-stu-id="1b778-148">For more information and an example, see [Use SetSize, Size, and SizeLimit to limit cache size](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span></span>
> <span data-ttu-id="1b778-149">Una cache condivisa è condivisa da altri Framework o librerie.</span><span class="sxs-lookup"><span data-stu-id="1b778-149">A shared cache is one shared by other frameworks or libraries.</span></span> <span data-ttu-id="1b778-150">Ad esempio, EF Core utilizza la cache condivisa e non specifica una dimensione.</span><span class="sxs-lookup"><span data-stu-id="1b778-150">For example, EF Core uses the shared cache and does not specify a size.</span></span> 

<span data-ttu-id="1b778-151">La memorizzazione nella cache in memoria è un *servizio* a cui viene fatto riferimento da un'app che usa l' [inserimento delle dipendenze](xref:fundamentals/dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="1b778-151">In-memory caching is a *service* that's referenced from an app using [Dependency Injection](xref:fundamentals/dependency-injection).</span></span> <span data-ttu-id="1b778-152">Richiedere l' `IMemoryCache` istanza nel costruttore:</span><span class="sxs-lookup"><span data-stu-id="1b778-152">Request the `IMemoryCache` instance in the constructor:</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet_ctor)]

<span data-ttu-id="1b778-153">Il codice seguente usa [TryGetValue](/dotnet/api/microsoft.extensions.caching.memory.imemorycache.trygetvalue?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_IMemoryCache_TryGetValue_System_Object_System_Object__) per verificare se un'ora è nella cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-153">The following code uses [TryGetValue](/dotnet/api/microsoft.extensions.caching.memory.imemorycache.trygetvalue?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_IMemoryCache_TryGetValue_System_Object_System_Object__) to check if a time is in the cache.</span></span> <span data-ttu-id="1b778-154">Se l'ora non viene memorizzata nella cache, viene creata una nuova voce che viene aggiunta alla cache con [set](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.set?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_CacheExtensions_Set__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object___0_Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_).</span><span class="sxs-lookup"><span data-stu-id="1b778-154">If a time isn't cached, a new entry is created and added to the cache with [Set](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.set?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_CacheExtensions_Set__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object___0_Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_).</span></span> <span data-ttu-id="1b778-155">La `CacheKeys` classe fa parte dell'esempio di download.</span><span class="sxs-lookup"><span data-stu-id="1b778-155">The `CacheKeys` class is part of the download sample.</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/CacheKeys.cs)]

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet1)]

<span data-ttu-id="1b778-156">Vengono visualizzati l'ora corrente e l'ora memorizzata nella cache:</span><span class="sxs-lookup"><span data-stu-id="1b778-156">The current time and the cached time are displayed:</span></span>

[!code-cshtml[](memory/3.0sample/WebCacheSample/Views/Home/Cache.cshtml)]

<span data-ttu-id="1b778-157">Il valore memorizzato nella `DateTime` cache rimane nella cache mentre sono presenti richieste entro il periodo di timeout.</span><span class="sxs-lookup"><span data-stu-id="1b778-157">The cached `DateTime` value remains in the cache while there are requests within the timeout period.</span></span>

<span data-ttu-id="1b778-158">Il codice seguente usa [GetOrCreate](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreate#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreate__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry___0__) e [GetOrCreateAsync](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreateasync#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreateAsync__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry_System_Threading_Tasks_Task___0___) per memorizzare i dati nella cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-158">The following code uses [GetOrCreate](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreate#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreate__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry___0__) and [GetOrCreateAsync](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreateasync#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreateAsync__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry_System_Threading_Tasks_Task___0___) to cache data.</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet2&highlight=3-7,14-19)]

<span data-ttu-id="1b778-159">Il codice seguente chiama [Get](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.get#Microsoft_Extensions_Caching_Memory_CacheExtensions_Get__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_) per recuperare l'ora memorizzata nella cache:</span><span class="sxs-lookup"><span data-stu-id="1b778-159">The following code calls [Get](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.get#Microsoft_Extensions_Caching_Memory_CacheExtensions_Get__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_) to fetch the cached time:</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet_gct)]

<span data-ttu-id="1b778-160">Il codice seguente ottiene o crea un elemento memorizzato nella cache con scadenza assoluta:</span><span class="sxs-lookup"><span data-stu-id="1b778-160">The following code gets or creates a cached item with absolute expiration:</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet99)]

<span data-ttu-id="1b778-161">Un set di elementi memorizzato nella cache con una scadenza variabile è a rischio di diventare obsoleto.</span><span class="sxs-lookup"><span data-stu-id="1b778-161">A cached item set with a sliding expiration only is at risk of becoming stale.</span></span> <span data-ttu-id="1b778-162">Se si accede con maggiore frequenza rispetto all'intervallo di scadenza variabile, l'elemento non scadrà mai.</span><span class="sxs-lookup"><span data-stu-id="1b778-162">If it's accessed more frequently than the sliding expiration interval, the item will never expire.</span></span> <span data-ttu-id="1b778-163">Combinare una scadenza variabile con una scadenza assoluta per garantire che l'elemento scada al termine del periodo di scadenza assoluto.</span><span class="sxs-lookup"><span data-stu-id="1b778-163">Combine a sliding expiration with an absolute expiration to guarantee that the item expires once its absolute expiration time passes.</span></span> <span data-ttu-id="1b778-164">La scadenza assoluta imposta un limite superiore per quanto tempo l'elemento può essere memorizzato nella cache, consentendo comunque la scadenza dell'elemento in un momento precedente se non è richiesto entro l'intervallo di scadenza variabile.</span><span class="sxs-lookup"><span data-stu-id="1b778-164">The absolute expiration sets an upper bound to how long the item can be cached while still allowing the item to expire earlier if it isn't requested within the sliding expiration interval.</span></span> <span data-ttu-id="1b778-165">Quando vengono specificate sia la scadenza assoluta che quella variabile, le scadenze sono logicamente ORed.</span><span class="sxs-lookup"><span data-stu-id="1b778-165">When both absolute and sliding expiration are specified, the expirations are logically ORed.</span></span> <span data-ttu-id="1b778-166">Se l'intervallo di scadenza variabile *o* l'ora di scadenza assoluta passano, l'elemento viene rimosso dalla cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-166">If either the sliding expiration interval *or* the absolute expiration time pass, the item is evicted from the cache.</span></span>

<span data-ttu-id="1b778-167">Il codice seguente ottiene o crea un elemento memorizzato nella cache con una scadenza scorrevole *e* assoluta:</span><span class="sxs-lookup"><span data-stu-id="1b778-167">The following code gets or creates a cached item with both sliding *and* absolute expiration:</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet9)]

<span data-ttu-id="1b778-168">Il codice precedente garantisce che i dati non verranno memorizzati nella cache più a lungo del tempo assoluto.</span><span class="sxs-lookup"><span data-stu-id="1b778-168">The preceding code guarantees the data will not be cached longer than the absolute time.</span></span>

<span data-ttu-id="1b778-169"><xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreate*>, <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreateAsync*> e <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.Get*> sono metodi di estensione nella <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions> classe.</span><span class="sxs-lookup"><span data-stu-id="1b778-169"><xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreate*>, <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreateAsync*>, and <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.Get*> are extension methods in the <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions> class.</span></span> <span data-ttu-id="1b778-170">Questi metodi estendono le funzionalità di <xref:Microsoft.Extensions.Caching.Memory.IMemoryCache> .</span><span class="sxs-lookup"><span data-stu-id="1b778-170">These methods extend the capability of <xref:Microsoft.Extensions.Caching.Memory.IMemoryCache>.</span></span>

## <a name="memorycacheentryoptions"></a><span data-ttu-id="1b778-171">MemoryCacheEntryOptions</span><span class="sxs-lookup"><span data-stu-id="1b778-171">MemoryCacheEntryOptions</span></span>

<span data-ttu-id="1b778-172">L'esempio seguente:</span><span class="sxs-lookup"><span data-stu-id="1b778-172">The following sample:</span></span>

* <span data-ttu-id="1b778-173">Imposta una data di scadenza variabile.</span><span class="sxs-lookup"><span data-stu-id="1b778-173">Sets a sliding expiration time.</span></span> <span data-ttu-id="1b778-174">Le richieste che accedono a questo elemento memorizzato nella cache reimpostano il clock di scadenza variabile.</span><span class="sxs-lookup"><span data-stu-id="1b778-174">Requests that access this cached item will reset the sliding expiration clock.</span></span>
* <span data-ttu-id="1b778-175">Imposta la priorità della cache su [CacheItemPriority. NeverRemove](xref:Microsoft.Extensions.Caching.Memory.CacheItemPriority.NeverRemove).</span><span class="sxs-lookup"><span data-stu-id="1b778-175">Sets the cache priority to [CacheItemPriority.NeverRemove](xref:Microsoft.Extensions.Caching.Memory.CacheItemPriority.NeverRemove).</span></span>
* <span data-ttu-id="1b778-176">Imposta un [PostEvictionDelegate](/dotnet/api/microsoft.extensions.caching.memory.postevictiondelegate) che verrà chiamato dopo la rimozione della voce dalla cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-176">Sets a [PostEvictionDelegate](/dotnet/api/microsoft.extensions.caching.memory.postevictiondelegate) that will be called after the entry is evicted from the cache.</span></span> <span data-ttu-id="1b778-177">Il callback viene eseguito su un thread diverso dal codice che rimuove l'elemento dalla cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-177">The callback is run on a different thread from the code that removes the item from the cache.</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet_et&highlight=14-21)]

## <a name="use-setsize-size-and-sizelimit-to-limit-cache-size"></a><span data-ttu-id="1b778-178">Usare le dimensioni di ridimensionamento, dimensioni e SizeLimit per limitare le dimensioni della cache</span><span class="sxs-lookup"><span data-stu-id="1b778-178">Use SetSize, Size, and SizeLimit to limit cache size</span></span>

<span data-ttu-id="1b778-179">Un' `MemoryCache` istanza può facoltativamente specificare e applicare un limite di dimensioni.</span><span class="sxs-lookup"><span data-stu-id="1b778-179">A `MemoryCache` instance may optionally specify and enforce a size limit.</span></span> <span data-ttu-id="1b778-180">Il limite delle dimensioni della cache non dispone di un'unità di misura definita perché la cache non ha alcun meccanismo per misurare la dimensione delle voci.</span><span class="sxs-lookup"><span data-stu-id="1b778-180">The cache size limit does not have a defined unit of measure because the cache has no mechanism to measure the size of entries.</span></span> <span data-ttu-id="1b778-181">Se viene impostato il limite delle dimensioni della cache, è necessario che tutte le voci specifichino la dimensione.</span><span class="sxs-lookup"><span data-stu-id="1b778-181">If the cache size limit is set, all entries must specify size.</span></span> <span data-ttu-id="1b778-182">Il runtime di ASP.NET Core non limita le dimensioni della cache in base all'utilizzo eccessivo della memoria.</span><span class="sxs-lookup"><span data-stu-id="1b778-182">The ASP.NET Core runtime does not limit cache size based on memory pressure.</span></span> <span data-ttu-id="1b778-183">Spetta allo sviluppatore limitare le dimensioni della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-183">It's up to the developer to limit cache size.</span></span> <span data-ttu-id="1b778-184">Le dimensioni specificate sono in unità scelte dallo sviluppatore.</span><span class="sxs-lookup"><span data-stu-id="1b778-184">The size specified is in units the developer chooses.</span></span>

<span data-ttu-id="1b778-185">Ad esempio:</span><span class="sxs-lookup"><span data-stu-id="1b778-185">For example:</span></span>

* <span data-ttu-id="1b778-186">Se l'app Web è stata utilizzata principalmente per la memorizzazione nella cache delle stringhe, le dimensioni della voce della cache potrebbero essere la lunghezza della stringa.</span><span class="sxs-lookup"><span data-stu-id="1b778-186">If the web app was primarily caching strings, each cache entry size could be the string length.</span></span>
* <span data-ttu-id="1b778-187">L'app può specificare le dimensioni di tutte le voci come 1 e il limite di dimensioni è il numero di voci.</span><span class="sxs-lookup"><span data-stu-id="1b778-187">The app could specify the size of all entries as 1, and the size limit is the count of entries.</span></span>

<span data-ttu-id="1b778-188">Se <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheOptions.SizeLimit> non è impostato, la cache cresce senza alcun limite.</span><span class="sxs-lookup"><span data-stu-id="1b778-188">If <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheOptions.SizeLimit> isn't set, the cache grows without bound.</span></span> <span data-ttu-id="1b778-189">Il runtime di ASP.NET Core non elimina la cache quando la memoria di sistema è insufficiente.</span><span class="sxs-lookup"><span data-stu-id="1b778-189">The ASP.NET Core runtime doesn't trim the cache when system memory is low.</span></span> <span data-ttu-id="1b778-190">Le app devono essere progettate per:</span><span class="sxs-lookup"><span data-stu-id="1b778-190">Apps must be architected to:</span></span>

* <span data-ttu-id="1b778-191">Limitare la crescita della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-191">Limit cache growth.</span></span>
* <span data-ttu-id="1b778-192">Chiamare <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Compact*> o <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Remove*> quando la memoria disponibile è limitata:</span><span class="sxs-lookup"><span data-stu-id="1b778-192">Call <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Compact*> or <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Remove*> when available memory is limited:</span></span>

<span data-ttu-id="1b778-193">Il codice seguente consente di creare una dimensione fissa unificata <xref:Microsoft.Extensions.Caching.Memory.MemoryCache> accessibile dall' [inserimento delle dipendenze](xref:fundamentals/dependency-injection):</span><span class="sxs-lookup"><span data-stu-id="1b778-193">The following code creates a unitless fixed size <xref:Microsoft.Extensions.Caching.Memory.MemoryCache> accessible by [dependency injection](xref:fundamentals/dependency-injection):</span></span>

[!code-csharp[](memory/sample/RPcache/Services/MyMemoryCache.cs?name=snippet)]

<span data-ttu-id="1b778-194">`SizeLimit`non dispone di unità.</span><span class="sxs-lookup"><span data-stu-id="1b778-194">`SizeLimit` does not have units.</span></span> <span data-ttu-id="1b778-195">Le voci memorizzate nella cache devono specificare le dimensioni in qualsiasi unità ritenute più appropriate se è stato impostato il limite delle dimensioni della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-195">Cached entries must specify size in whatever units they deem most appropriate if the cache size limit has been set.</span></span> <span data-ttu-id="1b778-196">Tutti gli utenti di un'istanza della cache devono usare lo stesso sistema di unità.</span><span class="sxs-lookup"><span data-stu-id="1b778-196">All users of a cache instance should use the same unit system.</span></span> <span data-ttu-id="1b778-197">Una voce non verrà memorizzata nella cache se la somma delle dimensioni della voce memorizzata nella cache supera il valore specificato da `SizeLimit` .</span><span class="sxs-lookup"><span data-stu-id="1b778-197">An entry will not be cached if the sum of the cached entry sizes exceeds the value specified by `SizeLimit`.</span></span> <span data-ttu-id="1b778-198">Se non è impostato alcun limite per le dimensioni della cache, le dimensioni della cache impostate per la voce verranno ignorate.</span><span class="sxs-lookup"><span data-stu-id="1b778-198">If no cache size limit is set, the cache size set on the entry will be ignored.</span></span>

<span data-ttu-id="1b778-199">Il codice seguente esegue la registrazione `MyMemoryCache` con il contenitore di [inserimento delle dipendenze](xref:fundamentals/dependency-injection) .</span><span class="sxs-lookup"><span data-stu-id="1b778-199">The following code registers `MyMemoryCache` with the [dependency injection](xref:fundamentals/dependency-injection) container.</span></span>

[!code-csharp[](memory/3.0sample/RPcache/Startup.cs?name=snippet)]

<span data-ttu-id="1b778-200">`MyMemoryCache`viene creato come cache di memoria indipendente per i componenti che sono consapevoli di questa dimensione limitata della cache e sanno come impostare la dimensione della voce della cache in modo appropriato.</span><span class="sxs-lookup"><span data-stu-id="1b778-200">`MyMemoryCache` is created as an independent memory cache for components that are aware of this size limited cache and know how to set cache entry size appropriately.</span></span>

<span data-ttu-id="1b778-201">Il codice seguente usa `MyMemoryCache` :</span><span class="sxs-lookup"><span data-stu-id="1b778-201">The following code uses `MyMemoryCache`:</span></span>

[!code-csharp[](memory/3.0sample/RPcache/Pages/SetSize.cshtml.cs?name=snippet)]

<span data-ttu-id="1b778-202">La dimensione della voce della cache può essere impostata da <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheEntryOptions.Size> o dai <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheEntryExtensions.SetSize*> metodi di estensione:</span><span class="sxs-lookup"><span data-stu-id="1b778-202">The size of the cache entry can be set by <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheEntryOptions.Size> or the <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheEntryExtensions.SetSize*> extension methods:</span></span>

[!code-csharp[](memory/3.0sample/RPcache/Pages/SetSize.cshtml.cs?name=snippet2&highlight=9,10,14,15)]

### <a name="memorycachecompact"></a><span data-ttu-id="1b778-203">MemoryCache. Compact</span><span class="sxs-lookup"><span data-stu-id="1b778-203">MemoryCache.Compact</span></span>

<span data-ttu-id="1b778-204">`MemoryCache.Compact`tenta di rimuovere la percentuale specificata della cache nell'ordine seguente:</span><span class="sxs-lookup"><span data-stu-id="1b778-204">`MemoryCache.Compact` attempts to remove the specified percentage of the cache in the following order:</span></span>

* <span data-ttu-id="1b778-205">Tutti gli elementi scaduti.</span><span class="sxs-lookup"><span data-stu-id="1b778-205">All expired items.</span></span>
* <span data-ttu-id="1b778-206">Elementi per priorità.</span><span class="sxs-lookup"><span data-stu-id="1b778-206">Items by priority.</span></span> <span data-ttu-id="1b778-207">Gli elementi con priorità più bassa vengono rimossi per primi.</span><span class="sxs-lookup"><span data-stu-id="1b778-207">Lowest priority items are removed first.</span></span>
* <span data-ttu-id="1b778-208">Oggetti utilizzati meno di recente.</span><span class="sxs-lookup"><span data-stu-id="1b778-208">Least recently used objects.</span></span>
* <span data-ttu-id="1b778-209">Elementi con la prima scadenza assoluta.</span><span class="sxs-lookup"><span data-stu-id="1b778-209">Items with the earliest absolute expiration.</span></span>
* <span data-ttu-id="1b778-210">Elementi con la scadenza variabile meno recente.</span><span class="sxs-lookup"><span data-stu-id="1b778-210">Items with the earliest sliding expiration.</span></span>

<span data-ttu-id="1b778-211">Gli elementi aggiunti con priorità <xref:Microsoft.Extensions.Caching.Memory.CacheItemPriority.NeverRemove> non vengono mai rimossi.</span><span class="sxs-lookup"><span data-stu-id="1b778-211">Pinned items with priority <xref:Microsoft.Extensions.Caching.Memory.CacheItemPriority.NeverRemove> are never removed.</span></span> <span data-ttu-id="1b778-212">Il codice seguente rimuove un elemento della cache e chiama `Compact` :</span><span class="sxs-lookup"><span data-stu-id="1b778-212">The following code removes a cache item and calls `Compact`:</span></span>

[!code-csharp[](memory/3.0sample/RPcache/Pages/TestCache.cshtml.cs?name=snippet3)]

<span data-ttu-id="1b778-213">Per altre informazioni, vedere [Compact Source su GitHub](https://github.com/dotnet/extensions/blob/v3.0.0-preview8.19405.4/src/Caching/Memory/src/MemoryCache.cs#L382-L393) .</span><span class="sxs-lookup"><span data-stu-id="1b778-213">See [Compact source on GitHub](https://github.com/dotnet/extensions/blob/v3.0.0-preview8.19405.4/src/Caching/Memory/src/MemoryCache.cs#L382-L393) for more information.</span></span>

## <a name="cache-dependencies"></a><span data-ttu-id="1b778-214">Dipendenze della cache</span><span class="sxs-lookup"><span data-stu-id="1b778-214">Cache dependencies</span></span>

<span data-ttu-id="1b778-215">Nell'esempio seguente viene illustrato come impostare come scaduti una voce della cache in caso di scadenza di una voce dipendente.</span><span class="sxs-lookup"><span data-stu-id="1b778-215">The following sample shows how to expire a cache entry if a dependent entry expires.</span></span> <span data-ttu-id="1b778-216"><xref:Microsoft.Extensions.Primitives.CancellationChangeToken>Viene aggiunto un oggetto all'elemento memorizzato nella cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-216">A <xref:Microsoft.Extensions.Primitives.CancellationChangeToken> is added to the cached item.</span></span> <span data-ttu-id="1b778-217">Quando `Cancel` viene chiamato su `CancellationTokenSource` , entrambe le voci della cache vengono eliminate.</span><span class="sxs-lookup"><span data-stu-id="1b778-217">When `Cancel` is called on the `CancellationTokenSource`, both cache entries are evicted.</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet_ed)]

<span data-ttu-id="1b778-218">L'uso di un oggetto <xref:System.Threading.CancellationTokenSource> consente di rimuovere più voci della cache come gruppo.</span><span class="sxs-lookup"><span data-stu-id="1b778-218">Using a <xref:System.Threading.CancellationTokenSource> allows multiple cache entries to be evicted as a group.</span></span> <span data-ttu-id="1b778-219">Con il `using` modello nel codice precedente, le voci della cache create all'interno del `using` blocco erediteranno i trigger e le impostazioni di scadenza.</span><span class="sxs-lookup"><span data-stu-id="1b778-219">With the `using` pattern in the code above, cache entries created inside the `using` block will inherit triggers and expiration settings.</span></span>

## <a name="additional-notes"></a><span data-ttu-id="1b778-220">Note aggiuntive</span><span class="sxs-lookup"><span data-stu-id="1b778-220">Additional notes</span></span>

* <span data-ttu-id="1b778-221">La scadenza non viene eseguita in background.</span><span class="sxs-lookup"><span data-stu-id="1b778-221">Expiration doesn't happen in the background.</span></span> <span data-ttu-id="1b778-222">Non sono presenti timer che analizzano attivamente la cache per gli elementi scaduti.</span><span class="sxs-lookup"><span data-stu-id="1b778-222">There is no timer that actively scans the cache for expired items.</span></span> <span data-ttu-id="1b778-223">Qualsiasi attività nella cache ( `Get` , `Set` , `Remove` ) può attivare un'analisi in background per gli elementi scaduti.</span><span class="sxs-lookup"><span data-stu-id="1b778-223">Any activity on the cache (`Get`, `Set`, `Remove`) can trigger a background scan for expired items.</span></span> <span data-ttu-id="1b778-224">Un timer in `CancellationTokenSource` ( <xref:System.Threading.CancellationTokenSource.CancelAfter*> ) rimuove anche la voce e attiva un'analisi per gli elementi scaduti.</span><span class="sxs-lookup"><span data-stu-id="1b778-224">A timer on the `CancellationTokenSource` (<xref:System.Threading.CancellationTokenSource.CancelAfter*>) also removes the entry and trigger a scan for expired items.</span></span> <span data-ttu-id="1b778-225">Nell'esempio seguente viene utilizzato [CancellationTokenSource (TimeSpan)](/dotnet/api/system.threading.cancellationtokensource.-ctor) per il token registrato.</span><span class="sxs-lookup"><span data-stu-id="1b778-225">The following example uses [CancellationTokenSource(TimeSpan)](/dotnet/api/system.threading.cancellationtokensource.-ctor) for the registered token.</span></span> <span data-ttu-id="1b778-226">Quando questo token viene attivato, rimuove immediatamente la voce e genera i callback di rimozione:</span><span class="sxs-lookup"><span data-stu-id="1b778-226">When this token fires it removes the entry immediately and fires the eviction callbacks:</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet_ae)]

* <span data-ttu-id="1b778-227">Quando si usa un callback per ripopolare un elemento della cache:</span><span class="sxs-lookup"><span data-stu-id="1b778-227">When using a callback to repopulate a cache item:</span></span>

  * <span data-ttu-id="1b778-228">Più richieste possono trovare il valore della chiave memorizzato nella cache perché il callback non è stato completato.</span><span class="sxs-lookup"><span data-stu-id="1b778-228">Multiple requests can find the cached key value empty because the callback hasn't completed.</span></span>
  * <span data-ttu-id="1b778-229">Questo può comportare la ricompilazione dell'elemento memorizzato nella cache da parte di più thread.</span><span class="sxs-lookup"><span data-stu-id="1b778-229">This can result in several threads repopulating the cached item.</span></span>

* <span data-ttu-id="1b778-230">Quando viene utilizzata una voce della cache per crearne un'altra, l'elemento figlio copia i token di scadenza della voce padre e le impostazioni di scadenza basate sul tempo.</span><span class="sxs-lookup"><span data-stu-id="1b778-230">When one cache entry is used to create another, the child copies the parent entry's expiration tokens and time-based expiration settings.</span></span> <span data-ttu-id="1b778-231">L'elemento figlio non è scaduto dalla rimozione manuale o dall'aggiornamento della voce padre.</span><span class="sxs-lookup"><span data-stu-id="1b778-231">The child isn't expired by manual removal or updating of the parent entry.</span></span>

* <span data-ttu-id="1b778-232">Utilizzare <xref:Microsoft.Extensions.Caching.Memory.ICacheEntry.PostEvictionCallbacks> per impostare i callback che verranno generati dopo la rimozione della voce della cache dalla cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-232">Use <xref:Microsoft.Extensions.Caching.Memory.ICacheEntry.PostEvictionCallbacks> to set the callbacks that will be fired after the cache entry is evicted from the cache.</span></span>
* <span data-ttu-id="1b778-233">Per la maggior parte delle app `IMemoryCache` è abilitato.</span><span class="sxs-lookup"><span data-stu-id="1b778-233">For most apps, `IMemoryCache` is enabled.</span></span> <span data-ttu-id="1b778-234">Ad esempio, chiamando `AddMvc` , `AddControllersWithViews` , `AddRazorPages` , `AddMvcCore().AddRazorViewEngine` e molti altri `Add{Service}` metodi in `ConfigureServices` , Abilita `IMemoryCache` .</span><span class="sxs-lookup"><span data-stu-id="1b778-234">For example, calling `AddMvc`, `AddControllersWithViews`, `AddRazorPages`, `AddMvcCore().AddRazorViewEngine`, and many other `Add{Service}` methods in `ConfigureServices`, enables `IMemoryCache`.</span></span> <span data-ttu-id="1b778-235">Per le app che non chiamano uno dei metodi precedenti `Add{Service}` , potrebbe essere necessario chiamare <xref:Microsoft.Extensions.DependencyInjection.MemoryCacheServiceCollectionExtensions.AddMemoryCache*> in `ConfigureServices` .</span><span class="sxs-lookup"><span data-stu-id="1b778-235">For apps that are not calling one of the preceding `Add{Service}` methods, it may be necessary to call <xref:Microsoft.Extensions.DependencyInjection.MemoryCacheServiceCollectionExtensions.AddMemoryCache*> in `ConfigureServices`.</span></span>

## <a name="background-cache-update"></a><span data-ttu-id="1b778-236">Aggiornamento della cache in background</span><span class="sxs-lookup"><span data-stu-id="1b778-236">Background cache update</span></span>

<span data-ttu-id="1b778-237">Usare un [servizio in background](xref:fundamentals/host/hosted-services) , ad esempio <xref:Microsoft.Extensions.Hosting.IHostedService> per aggiornare la cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-237">Use a [background service](xref:fundamentals/host/hosted-services) such as <xref:Microsoft.Extensions.Hosting.IHostedService> to update the cache.</span></span> <span data-ttu-id="1b778-238">Il servizio in background può ricalcolare le voci e quindi assegnarle alla cache solo quando sono pronte.</span><span class="sxs-lookup"><span data-stu-id="1b778-238">The background service can recompute the entries and then assign them to the cache only when they’re ready.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="1b778-239">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="1b778-239">Additional resources</span></span>

* <xref:performance/caching/distributed>
* <xref:fundamentals/change-tokens>
* <xref:performance/caching/response>
* <xref:performance/caching/middleware>
* <xref:mvc/views/tag-helpers/builtin-th/cache-tag-helper>
* <xref:mvc/views/tag-helpers/builtin-th/distributed-cache-tag-helper>

::: moniker-end

::: moniker range="< aspnetcore-3.0"

<!-- This is the 2.1 version -->
<span data-ttu-id="1b778-240">Di [Rick Anderson](https://twitter.com/RickAndMSFT), [John Luo](https://github.com/JunTaoLuo)e [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="1b778-240">By [Rick Anderson](https://twitter.com/RickAndMSFT), [John Luo](https://github.com/JunTaoLuo), and [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="1b778-241">[Visualizzare o scaricare il codice di esempio](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/memory/sample) ([procedura per il download](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="1b778-241">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/memory/sample) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="caching-basics"></a><span data-ttu-id="1b778-242">Nozioni fondamentali sulla memorizzazione nella cache</span><span class="sxs-lookup"><span data-stu-id="1b778-242">Caching basics</span></span>

<span data-ttu-id="1b778-243">La memorizzazione nella cache può migliorare significativamente le prestazioni e la scalabilità di un'app riducendo il lavoro necessario per generare il contenuto.</span><span class="sxs-lookup"><span data-stu-id="1b778-243">Caching can significantly improve the performance and scalability of an app by reducing the work required to generate content.</span></span> <span data-ttu-id="1b778-244">La memorizzazione nella cache funziona meglio con i dati che cambiano raramente.</span><span class="sxs-lookup"><span data-stu-id="1b778-244">Caching works best with data that changes infrequently.</span></span> <span data-ttu-id="1b778-245">La memorizzazione nella cache crea una copia dei dati che possono essere restituiti molto più velocemente rispetto a quelli dell'origine originale.</span><span class="sxs-lookup"><span data-stu-id="1b778-245">Caching makes a copy of data that can be returned much faster than from the original source.</span></span> <span data-ttu-id="1b778-246">Il codice deve essere scritto e testato in modo da non dipendere **mai** dai dati memorizzati nella cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-246">Code should be written and tested to **never** depend on cached data.</span></span>

<span data-ttu-id="1b778-247">ASP.NET Core supporta diverse cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-247">ASP.NET Core supports several different caches.</span></span> <span data-ttu-id="1b778-248">La cache più semplice si basa su [IMemoryCache](/dotnet/api/microsoft.extensions.caching.memory.imemorycache), che rappresenta una cache archiviata nella memoria del server Web.</span><span class="sxs-lookup"><span data-stu-id="1b778-248">The simplest cache is based on the [IMemoryCache](/dotnet/api/microsoft.extensions.caching.memory.imemorycache), which represents a cache stored in the memory of the web server.</span></span> <span data-ttu-id="1b778-249">Le app eseguite in un server farm (più server) devono garantire che le sessioni siano permanenti quando si usa la cache in memoria.</span><span class="sxs-lookup"><span data-stu-id="1b778-249">Apps that run on a server farm (multiple servers) should ensure that sessions are sticky when using the in-memory cache.</span></span> <span data-ttu-id="1b778-250">Le sessioni permanenti garantiscono che le richieste successive provenienti da un client vadano tutte allo stesso server.</span><span class="sxs-lookup"><span data-stu-id="1b778-250">Sticky sessions ensure that later requests from a client all go to the same server.</span></span> <span data-ttu-id="1b778-251">Ad esempio, le app Web di Azure usano [Application Request Routing](https://www.iis.net/learn/extensions/planning-for-arr) (arr) per indirizzare tutte le richieste da un agente utente allo stesso server.</span><span class="sxs-lookup"><span data-stu-id="1b778-251">For example, Azure Web apps use [Application Request Routing](https://www.iis.net/learn/extensions/planning-for-arr) (ARR) to route all requests from a user agent to the same server.</span></span>

<span data-ttu-id="1b778-252">Le sessioni non permanenti in una Web farm richiedono una [cache distribuita](distributed.md) per evitare problemi di coerenza della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-252">Non-sticky sessions in a web farm require a [distributed cache](distributed.md) to avoid cache consistency problems.</span></span> <span data-ttu-id="1b778-253">Per alcune app, una cache distribuita può supportare una maggiore scalabilità orizzontale rispetto a una cache in memoria.</span><span class="sxs-lookup"><span data-stu-id="1b778-253">For some apps, a distributed cache can support higher scale-out than an in-memory cache.</span></span> <span data-ttu-id="1b778-254">L'uso di una cache distribuita trasferisce la memoria cache a un processo esterno.</span><span class="sxs-lookup"><span data-stu-id="1b778-254">Using a distributed cache offloads the cache memory to an external process.</span></span>

<span data-ttu-id="1b778-255">La cache in memoria può archiviare qualsiasi oggetto.</span><span class="sxs-lookup"><span data-stu-id="1b778-255">The in-memory cache can store any object.</span></span> <span data-ttu-id="1b778-256">L'interfaccia della cache distribuita è limitata a `byte[]` .</span><span class="sxs-lookup"><span data-stu-id="1b778-256">The distributed cache interface is limited to `byte[]`.</span></span> <span data-ttu-id="1b778-257">Gli elementi memorizzati nella cache in memoria e nella cache distribuita vengono archiviati come coppie chiave-valore.</span><span class="sxs-lookup"><span data-stu-id="1b778-257">The in-memory and distributed cache store cache items as key-value pairs.</span></span>

## <a name="systemruntimecachingmemorycache"></a><span data-ttu-id="1b778-258">System. Runtime. Caching/MemoryCache</span><span class="sxs-lookup"><span data-stu-id="1b778-258">System.Runtime.Caching/MemoryCache</span></span>

<span data-ttu-id="1b778-259"><xref:System.Runtime.Caching>/<xref:System.Runtime.Caching.MemoryCache>([Pacchetto NuGet](https://www.nuget.org/packages/System.Runtime.Caching/)) può essere usato con:</span><span class="sxs-lookup"><span data-stu-id="1b778-259"><xref:System.Runtime.Caching>/<xref:System.Runtime.Caching.MemoryCache> ([NuGet package](https://www.nuget.org/packages/System.Runtime.Caching/)) can be used with:</span></span>

* <span data-ttu-id="1b778-260">.NET Standard 2,0 o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="1b778-260">.NET Standard 2.0 or later.</span></span>
* <span data-ttu-id="1b778-261">Qualsiasi [implementazione di .NET](/dotnet/standard/net-standard#net-implementation-support) destinata a .NET standard 2,0 o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="1b778-261">Any [.NET implementation](/dotnet/standard/net-standard#net-implementation-support) that targets .NET Standard 2.0 or later.</span></span> <span data-ttu-id="1b778-262">Ad esempio, ASP.NET Core 2,0 o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="1b778-262">For example, ASP.NET Core 2.0 or later.</span></span>
* <span data-ttu-id="1b778-263">.NET Framework 4.5 o versioni successive.</span><span class="sxs-lookup"><span data-stu-id="1b778-263">.NET Framework 4.5 or later.</span></span>

<span data-ttu-id="1b778-264">È consigliabile usare [Microsoft. Extensions. Caching. memory](https://www.nuget.org/packages/Microsoft.Extensions.Caching.Memory/) / `IMemoryCache` (descritto in questo articolo) `System.Runtime.Caching` / `MemoryCache` perché è più integrato in ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="1b778-264">[Microsoft.Extensions.Caching.Memory](https://www.nuget.org/packages/Microsoft.Extensions.Caching.Memory/)/`IMemoryCache` (described in this article) is recommended over `System.Runtime.Caching`/`MemoryCache` because it's better integrated into ASP.NET Core.</span></span> <span data-ttu-id="1b778-265">Ad esempio, `IMemoryCache` funziona in modo nativo con ASP.NET Core [inserimento delle dipendenze](xref:fundamentals/dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="1b778-265">For example, `IMemoryCache` works natively with ASP.NET Core [dependency injection](xref:fundamentals/dependency-injection).</span></span>

<span data-ttu-id="1b778-266">Usare `System.Runtime.Caching` / `MemoryCache` come Bridge di compatibilità quando si porta il codice da ASP.NET 4. x a ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="1b778-266">Use `System.Runtime.Caching`/`MemoryCache` as a compatibility bridge when porting code from ASP.NET 4.x to ASP.NET Core.</span></span>

## <a name="cache-guidelines"></a><span data-ttu-id="1b778-267">Linee guida per la cache</span><span class="sxs-lookup"><span data-stu-id="1b778-267">Cache guidelines</span></span>

* <span data-ttu-id="1b778-268">Il codice deve sempre avere un'opzione di fallback per recuperare i dati e **non** dipendere da un valore memorizzato nella cache disponibile.</span><span class="sxs-lookup"><span data-stu-id="1b778-268">Code should always have a fallback option to fetch data and **not** depend on a cached value being available.</span></span>
* <span data-ttu-id="1b778-269">La cache usa una risorsa scarsa, ovvero la memoria.</span><span class="sxs-lookup"><span data-stu-id="1b778-269">The cache uses a scarce resource, memory.</span></span> <span data-ttu-id="1b778-270">Limita aumento dimensioni cache:</span><span class="sxs-lookup"><span data-stu-id="1b778-270">Limit cache growth:</span></span>
  * <span data-ttu-id="1b778-271">Non **usare input** esterno come chiavi di cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-271">Do **not** use external input as cache keys.</span></span>
  * <span data-ttu-id="1b778-272">Usare le scadenze per limitare la crescita della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-272">Use expirations to limit cache growth.</span></span>
  * <span data-ttu-id="1b778-273">[Per limitare le dimensioni della cache, usare le dimensioni, le dimensioni e il valore di SizeLimit](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span><span class="sxs-lookup"><span data-stu-id="1b778-273">[Use SetSize, Size, and SizeLimit to limit cache size](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span></span> <span data-ttu-id="1b778-274">Il runtime di ASP.NET Core non limita le dimensioni della cache in base all'utilizzo eccessivo della memoria.</span><span class="sxs-lookup"><span data-stu-id="1b778-274">The ASP.NET Core runtime does not limit cache size based on memory pressure.</span></span> <span data-ttu-id="1b778-275">Spetta allo sviluppatore limitare le dimensioni della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-275">It's up to the developer to limit cache size.</span></span>

## <a name="using-imemorycache"></a><span data-ttu-id="1b778-276">Uso di IMemoryCache</span><span class="sxs-lookup"><span data-stu-id="1b778-276">Using IMemoryCache</span></span>

> [!WARNING]
> <span data-ttu-id="1b778-277">L'uso di una cache *Shared* Memory dall' [inserimento delle dipendenze](xref:fundamentals/dependency-injection) e della chiamata `SetSize` `Size` di, o `SizeLimit` per limitare le dimensioni della cache può causare un errore dell'app.</span><span class="sxs-lookup"><span data-stu-id="1b778-277">Using a *shared* memory cache from [Dependency Injection](xref:fundamentals/dependency-injection) and calling `SetSize`, `Size`, or `SizeLimit` to limit cache size can cause the app to fail.</span></span> <span data-ttu-id="1b778-278">Quando si imposta un limite di dimensioni in una cache, è necessario che tutte le voci specifichino una dimensione al momento dell'aggiunta.</span><span class="sxs-lookup"><span data-stu-id="1b778-278">When a size limit is set on a cache, all entries must specify a size when being added.</span></span> <span data-ttu-id="1b778-279">Questo può causare problemi perché gli sviluppatori potrebbero non avere il controllo completo su ciò che usa la cache condivisa.</span><span class="sxs-lookup"><span data-stu-id="1b778-279">This can lead to issues since developers may not have full control on what uses the shared cache.</span></span> <span data-ttu-id="1b778-280">Ad esempio, Entity Framework Core utilizza la cache condivisa e non specifica una dimensione.</span><span class="sxs-lookup"><span data-stu-id="1b778-280">For example, Entity Framework Core uses the shared cache and does not specify a size.</span></span> <span data-ttu-id="1b778-281">Se un'app imposta un limite per le dimensioni della cache e USA EF Core, l'app genera un'eccezione `InvalidOperationException` .</span><span class="sxs-lookup"><span data-stu-id="1b778-281">If an app sets a cache size limit and uses EF Core, the app throws an `InvalidOperationException`.</span></span>
> <span data-ttu-id="1b778-282">Quando `SetSize` si usa, `Size` o `SizeLimit` per limitare la cache, creare un singleton della cache per la memorizzazione nella cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-282">When using `SetSize`, `Size`, or `SizeLimit` to limit cache, create a cache singleton for caching.</span></span> <span data-ttu-id="1b778-283">Per altre informazioni e per un esempio, vedere [use sesize, Size e SizeLimit per limitare le dimensioni della cache](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span><span class="sxs-lookup"><span data-stu-id="1b778-283">For more information and an example, see [Use SetSize, Size, and SizeLimit to limit cache size](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span></span>

<span data-ttu-id="1b778-284">La memorizzazione nella cache in memoria è un *servizio* a cui viene fatto riferimento dall'app mediante l' [inserimento di dipendenze](../../fundamentals/dependency-injection.md).</span><span class="sxs-lookup"><span data-stu-id="1b778-284">In-memory caching is a *service* that's referenced from your app using [Dependency Injection](../../fundamentals/dependency-injection.md).</span></span> <span data-ttu-id="1b778-285">Chiama `AddMemoryCache` in `ConfigureServices` :</span><span class="sxs-lookup"><span data-stu-id="1b778-285">Call `AddMemoryCache` in `ConfigureServices`:</span></span>

[!code-csharp[](memory/sample/WebCache/Startup.cs?highlight=9)]

<span data-ttu-id="1b778-286">Richiedere l' `IMemoryCache` istanza nel costruttore:</span><span class="sxs-lookup"><span data-stu-id="1b778-286">Request the `IMemoryCache` instance in the constructor:</span></span>

[!code-csharp[](memory/sample/WebCache/Controllers/HomeController.cs?name=snippet_ctor)]

<span data-ttu-id="1b778-287">`IMemoryCache`richiede il pacchetto NuGet [Microsoft. Extensions. Caching. memory](https://www.nuget.org/packages/Microsoft.Extensions.Caching.Memory/), disponibile nel [metapacchetto Microsoft. AspNetCore. app](xref:fundamentals/metapackage-app).</span><span class="sxs-lookup"><span data-stu-id="1b778-287">`IMemoryCache` requires NuGet package [Microsoft.Extensions.Caching.Memory](https://www.nuget.org/packages/Microsoft.Extensions.Caching.Memory/), which is available in the [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app).</span></span>

<span data-ttu-id="1b778-288">Il codice seguente usa [TryGetValue](/dotnet/api/microsoft.extensions.caching.memory.imemorycache.trygetvalue?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_IMemoryCache_TryGetValue_System_Object_System_Object__) per verificare se un'ora è nella cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-288">The following code uses [TryGetValue](/dotnet/api/microsoft.extensions.caching.memory.imemorycache.trygetvalue?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_IMemoryCache_TryGetValue_System_Object_System_Object__) to check if a time is in the cache.</span></span> <span data-ttu-id="1b778-289">Se l'ora non viene memorizzata nella cache, viene creata una nuova voce che viene aggiunta alla cache con [set](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.set?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_CacheExtensions_Set__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object___0_Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_).</span><span class="sxs-lookup"><span data-stu-id="1b778-289">If a time isn't cached, a new entry is created and added to the cache with [Set](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.set?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_CacheExtensions_Set__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object___0_Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_).</span></span>

[!code-csharp[](memory/sample/WebCache/CacheKeys.cs)]

[!code-csharp[](memory/sample/WebCache/Controllers/HomeController.cs?name=snippet1)]

<span data-ttu-id="1b778-290">Vengono visualizzati l'ora corrente e l'ora memorizzata nella cache:</span><span class="sxs-lookup"><span data-stu-id="1b778-290">The current time and the cached time are displayed:</span></span>

[!code-cshtml[](memory/sample/WebCache/Views/Home/Cache.cshtml)]

<span data-ttu-id="1b778-291">Il valore memorizzato nella `DateTime` cache rimane nella cache mentre sono presenti richieste entro il periodo di timeout.</span><span class="sxs-lookup"><span data-stu-id="1b778-291">The cached `DateTime` value remains in the cache while there are requests within the timeout period.</span></span> <span data-ttu-id="1b778-292">La figura seguente mostra l'ora corrente e un tempo precedente recuperato dalla cache:</span><span class="sxs-lookup"><span data-stu-id="1b778-292">The following image shows the current time and an older time retrieved from the cache:</span></span>

![Visualizzazione indice con due ore diverse visualizzate](memory/_static/time.png)

<span data-ttu-id="1b778-294">Il codice seguente usa [GetOrCreate](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreate#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreate__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry___0__) e [GetOrCreateAsync](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreateasync#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreateAsync__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry_System_Threading_Tasks_Task___0___) per memorizzare i dati nella cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-294">The following code uses [GetOrCreate](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreate#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreate__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry___0__) and [GetOrCreateAsync](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreateasync#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreateAsync__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry_System_Threading_Tasks_Task___0___) to cache data.</span></span>

[!code-csharp[](memory/sample/WebCache/Controllers/HomeController.cs?name=snippet2&highlight=3-7,14-19)]

<span data-ttu-id="1b778-295">Il codice seguente chiama [Get](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.get#Microsoft_Extensions_Caching_Memory_CacheExtensions_Get__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_) per recuperare l'ora memorizzata nella cache:</span><span class="sxs-lookup"><span data-stu-id="1b778-295">The following code calls [Get](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.get#Microsoft_Extensions_Caching_Memory_CacheExtensions_Get__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_) to fetch the cached time:</span></span>

[!code-csharp[](memory/sample/WebCache/Controllers/HomeController.cs?name=snippet_gct)]

<span data-ttu-id="1b778-296"><xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreate*>, <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreateAsync*> e [Get](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.get#Microsoft_Extensions_Caching_Memory_CacheExtensions_Get__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_) sono metodi di estensione parte della classe [CacheExtensions](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions) che estende la funzionalità di <xref:Microsoft.Extensions.Caching.Memory.IMemoryCache> .</span><span class="sxs-lookup"><span data-stu-id="1b778-296"><xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreate*> , <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreateAsync*>, and [Get](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.get#Microsoft_Extensions_Caching_Memory_CacheExtensions_Get__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_) are extension methods part of the [CacheExtensions](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions) class that extends the capability of <xref:Microsoft.Extensions.Caching.Memory.IMemoryCache>.</span></span> <span data-ttu-id="1b778-297">Vedere [Metodi IMemoryCache](/dotnet/api/microsoft.extensions.caching.memory.imemorycache) e [Metodi CacheExtensions](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions) per una descrizione di altri metodi della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-297">See [IMemoryCache methods](/dotnet/api/microsoft.extensions.caching.memory.imemorycache) and [CacheExtensions methods](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions) for a description of other cache methods.</span></span>

## <a name="memorycacheentryoptions"></a><span data-ttu-id="1b778-298">MemoryCacheEntryOptions</span><span class="sxs-lookup"><span data-stu-id="1b778-298">MemoryCacheEntryOptions</span></span>

<span data-ttu-id="1b778-299">L'esempio seguente:</span><span class="sxs-lookup"><span data-stu-id="1b778-299">The following sample:</span></span>

* <span data-ttu-id="1b778-300">Imposta una data di scadenza variabile.</span><span class="sxs-lookup"><span data-stu-id="1b778-300">Sets a sliding expiration time.</span></span> <span data-ttu-id="1b778-301">Le richieste che accedono a questo elemento memorizzato nella cache reimpostano il clock di scadenza variabile.</span><span class="sxs-lookup"><span data-stu-id="1b778-301">Requests that access this cached item will reset the sliding expiration clock.</span></span>
* <span data-ttu-id="1b778-302">Imposta la priorità della cache su `CacheItemPriority.NeverRemove` .</span><span class="sxs-lookup"><span data-stu-id="1b778-302">Sets the cache priority to `CacheItemPriority.NeverRemove`.</span></span>
* <span data-ttu-id="1b778-303">Imposta un [PostEvictionDelegate](/dotnet/api/microsoft.extensions.caching.memory.postevictiondelegate) che verrà chiamato dopo la rimozione della voce dalla cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-303">Sets a [PostEvictionDelegate](/dotnet/api/microsoft.extensions.caching.memory.postevictiondelegate) that will be called after the entry is evicted from the cache.</span></span> <span data-ttu-id="1b778-304">Il callback viene eseguito su un thread diverso dal codice che rimuove l'elemento dalla cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-304">The callback is run on a different thread from the code that removes the item from the cache.</span></span>

[!code-csharp[](memory/sample/WebCache/Controllers/HomeController.cs?name=snippet_et&highlight=14-21)]

## <a name="use-setsize-size-and-sizelimit-to-limit-cache-size"></a><span data-ttu-id="1b778-305">Usare le dimensioni di ridimensionamento, dimensioni e SizeLimit per limitare le dimensioni della cache</span><span class="sxs-lookup"><span data-stu-id="1b778-305">Use SetSize, Size, and SizeLimit to limit cache size</span></span>

<span data-ttu-id="1b778-306">Un' `MemoryCache` istanza può facoltativamente specificare e applicare un limite di dimensioni.</span><span class="sxs-lookup"><span data-stu-id="1b778-306">A `MemoryCache` instance may optionally specify and enforce a size limit.</span></span> <span data-ttu-id="1b778-307">Il limite delle dimensioni della cache non dispone di un'unità di misura definita perché la cache non ha alcun meccanismo per misurare la dimensione delle voci.</span><span class="sxs-lookup"><span data-stu-id="1b778-307">The cache size limit does not have a defined unit of measure because the cache has no mechanism to measure the size of entries.</span></span> <span data-ttu-id="1b778-308">Se viene impostato il limite delle dimensioni della cache, è necessario che tutte le voci specifichino la dimensione.</span><span class="sxs-lookup"><span data-stu-id="1b778-308">If the cache size limit is set, all entries must specify size.</span></span> <span data-ttu-id="1b778-309">Il runtime di ASP.NET Core non limita le dimensioni della cache in base all'utilizzo eccessivo della memoria.</span><span class="sxs-lookup"><span data-stu-id="1b778-309">The ASP.NET Core runtime does not limit cache size based on memory pressure.</span></span> <span data-ttu-id="1b778-310">Spetta allo sviluppatore limitare le dimensioni della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-310">It's up to the developer to limit cache size.</span></span> <span data-ttu-id="1b778-311">Le dimensioni specificate sono in unità scelte dallo sviluppatore.</span><span class="sxs-lookup"><span data-stu-id="1b778-311">The size specified is in units the developer chooses.</span></span>

<span data-ttu-id="1b778-312">Ad esempio:</span><span class="sxs-lookup"><span data-stu-id="1b778-312">For example:</span></span>

* <span data-ttu-id="1b778-313">Se l'app Web è stata utilizzata principalmente per la memorizzazione nella cache delle stringhe, le dimensioni della voce della cache potrebbero essere la lunghezza della stringa.</span><span class="sxs-lookup"><span data-stu-id="1b778-313">If the web app was primarily caching strings, each cache entry size could be the string length.</span></span>
* <span data-ttu-id="1b778-314">L'app può specificare le dimensioni di tutte le voci come 1 e il limite di dimensioni è il numero di voci.</span><span class="sxs-lookup"><span data-stu-id="1b778-314">The app could specify the size of all entries as 1, and the size limit is the count of entries.</span></span>

<span data-ttu-id="1b778-315">Se <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheOptions.SizeLimit> non è impostato, la cache cresce senza alcun limite.</span><span class="sxs-lookup"><span data-stu-id="1b778-315">If <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheOptions.SizeLimit> is not set, the cache grows without bound.</span></span> <span data-ttu-id="1b778-316">Il runtime di ASP.NET Core non elimina la cache quando la memoria di sistema è insufficiente.</span><span class="sxs-lookup"><span data-stu-id="1b778-316">The ASP.NET Core runtime does not trim the cache when system memory is low.</span></span> <span data-ttu-id="1b778-317">Le app sono molto progettate per:</span><span class="sxs-lookup"><span data-stu-id="1b778-317">Apps much be architected to:</span></span>

* <span data-ttu-id="1b778-318">Limitare la crescita della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-318">Limit cache growth.</span></span>
* <span data-ttu-id="1b778-319">Chiamare <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Compact*> o <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Remove*> quando la memoria disponibile è limitata:</span><span class="sxs-lookup"><span data-stu-id="1b778-319">Call <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Compact*> or <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Remove*> when available memory is limited:</span></span>

<span data-ttu-id="1b778-320">Il codice seguente consente di creare una dimensione fissa unificata <xref:Microsoft.Extensions.Caching.Memory.MemoryCache> accessibile dall' [inserimento delle dipendenze](xref:fundamentals/dependency-injection):</span><span class="sxs-lookup"><span data-stu-id="1b778-320">The following code creates a unitless fixed size <xref:Microsoft.Extensions.Caching.Memory.MemoryCache> accessible by [dependency injection](xref:fundamentals/dependency-injection):</span></span>

[!code-csharp[](memory/sample/RPcache/Services/MyMemoryCache.cs?name=snippet)]

<span data-ttu-id="1b778-321">`SizeLimit`non dispone di unità.</span><span class="sxs-lookup"><span data-stu-id="1b778-321">`SizeLimit` does not have units.</span></span> <span data-ttu-id="1b778-322">Le voci memorizzate nella cache devono specificare le dimensioni in qualsiasi unità ritenute più appropriate se è stato impostato il limite delle dimensioni della cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-322">Cached entries must specify size in whatever units they deem most appropriate if the cache size limit has been set.</span></span> <span data-ttu-id="1b778-323">Tutti gli utenti di un'istanza della cache devono usare lo stesso sistema di unità.</span><span class="sxs-lookup"><span data-stu-id="1b778-323">All users of a cache instance should use the same unit system.</span></span> <span data-ttu-id="1b778-324">Una voce non verrà memorizzata nella cache se la somma delle dimensioni della voce memorizzata nella cache supera il valore specificato da `SizeLimit` .</span><span class="sxs-lookup"><span data-stu-id="1b778-324">An entry will not be cached if the sum of the cached entry sizes exceeds the value specified by `SizeLimit`.</span></span> <span data-ttu-id="1b778-325">Se non è impostato alcun limite per le dimensioni della cache, le dimensioni della cache impostate per la voce verranno ignorate.</span><span class="sxs-lookup"><span data-stu-id="1b778-325">If no cache size limit is set, the cache size set on the entry will be ignored.</span></span>

<span data-ttu-id="1b778-326">Il codice seguente esegue la registrazione `MyMemoryCache` con il contenitore di [inserimento delle dipendenze](xref:fundamentals/dependency-injection) .</span><span class="sxs-lookup"><span data-stu-id="1b778-326">The following code registers `MyMemoryCache` with the [dependency injection](xref:fundamentals/dependency-injection) container.</span></span>

[!code-csharp[](memory/sample/RPcache/Startup.cs?name=snippet&highlight=5)]

<span data-ttu-id="1b778-327">`MyMemoryCache`viene creato come cache di memoria indipendente per i componenti che sono consapevoli di questa dimensione limitata della cache e sanno come impostare la dimensione della voce della cache in modo appropriato.</span><span class="sxs-lookup"><span data-stu-id="1b778-327">`MyMemoryCache` is created as an independent memory cache for components that are aware of this size limited cache and know how to set cache entry size appropriately.</span></span>

<span data-ttu-id="1b778-328">Il codice seguente usa `MyMemoryCache` :</span><span class="sxs-lookup"><span data-stu-id="1b778-328">The following code uses `MyMemoryCache`:</span></span>

[!code-csharp[](memory/sample/RPcache/Pages/About.cshtml.cs?name=snippet)]

<span data-ttu-id="1b778-329">La dimensione della voce della cache può essere impostata in base alle [dimensioni](/dotnet/api/microsoft.extensions.caching.memory.memorycacheentryoptions.size?view=aspnetcore-2.1#Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_Size) o al metodo di estensione [sesize](/dotnet/api/microsoft.extensions.caching.memory.memorycacheentryextensions.setsize?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_MemoryCacheEntryExtensions_SetSize_Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_System_Int64_) :</span><span class="sxs-lookup"><span data-stu-id="1b778-329">The size of the cache entry can be set by [Size](/dotnet/api/microsoft.extensions.caching.memory.memorycacheentryoptions.size?view=aspnetcore-2.1#Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_Size) or the [SetSize](/dotnet/api/microsoft.extensions.caching.memory.memorycacheentryextensions.setsize?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_MemoryCacheEntryExtensions_SetSize_Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_System_Int64_) extension method:</span></span>

[!code-csharp[](memory/sample/RPcache/Pages/About.cshtml.cs?name=snippet2&highlight=9,10,14,15)]

### <a name="memorycachecompact"></a><span data-ttu-id="1b778-330">MemoryCache. Compact</span><span class="sxs-lookup"><span data-stu-id="1b778-330">MemoryCache.Compact</span></span>

<span data-ttu-id="1b778-331">`MemoryCache.Compact`tenta di rimuovere la percentuale specificata della cache nell'ordine seguente:</span><span class="sxs-lookup"><span data-stu-id="1b778-331">`MemoryCache.Compact` attempts to remove the specified percentage of the cache in the following order:</span></span>

* <span data-ttu-id="1b778-332">Tutti gli elementi scaduti.</span><span class="sxs-lookup"><span data-stu-id="1b778-332">All expired items.</span></span>
* <span data-ttu-id="1b778-333">Elementi per priorità.</span><span class="sxs-lookup"><span data-stu-id="1b778-333">Items by priority.</span></span> <span data-ttu-id="1b778-334">Gli elementi con priorità più bassa vengono rimossi per primi.</span><span class="sxs-lookup"><span data-stu-id="1b778-334">Lowest priority items are removed first.</span></span>
* <span data-ttu-id="1b778-335">Oggetti utilizzati meno di recente.</span><span class="sxs-lookup"><span data-stu-id="1b778-335">Least recently used objects.</span></span>
* <span data-ttu-id="1b778-336">Elementi con la prima scadenza assoluta.</span><span class="sxs-lookup"><span data-stu-id="1b778-336">Items with the earliest absolute expiration.</span></span>
* <span data-ttu-id="1b778-337">Elementi con la scadenza variabile meno recente.</span><span class="sxs-lookup"><span data-stu-id="1b778-337">Items with the earliest sliding expiration.</span></span>

<span data-ttu-id="1b778-338">Gli elementi aggiunti con priorità <xref:Microsoft.Extensions.Caching.Memory.CacheItemPriority.NeverRemove> non vengono mai rimossi.</span><span class="sxs-lookup"><span data-stu-id="1b778-338">Pinned items with priority <xref:Microsoft.Extensions.Caching.Memory.CacheItemPriority.NeverRemove> are never removed.</span></span>

[!code-csharp[](memory/3.0sample/RPcache/Pages/TestCache.cshtml.cs?name=snippet3)]

<span data-ttu-id="1b778-339">Per altre informazioni, vedere [Compact Source su GitHub](https://github.com/dotnet/extensions/blob/v3.0.0-preview8.19405.4/src/Caching/Memory/src/MemoryCache.cs#L382-L393) .</span><span class="sxs-lookup"><span data-stu-id="1b778-339">See [Compact source on GitHub](https://github.com/dotnet/extensions/blob/v3.0.0-preview8.19405.4/src/Caching/Memory/src/MemoryCache.cs#L382-L393) for more information.</span></span>

## <a name="cache-dependencies"></a><span data-ttu-id="1b778-340">Dipendenze della cache</span><span class="sxs-lookup"><span data-stu-id="1b778-340">Cache dependencies</span></span>

<span data-ttu-id="1b778-341">Nell'esempio seguente viene illustrato come impostare come scaduti una voce della cache in caso di scadenza di una voce dipendente.</span><span class="sxs-lookup"><span data-stu-id="1b778-341">The following sample shows how to expire a cache entry if a dependent entry expires.</span></span> <span data-ttu-id="1b778-342"><xref:Microsoft.Extensions.Primitives.CancellationChangeToken>Viene aggiunto un oggetto all'elemento memorizzato nella cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-342">A <xref:Microsoft.Extensions.Primitives.CancellationChangeToken> is added to the cached item.</span></span> <span data-ttu-id="1b778-343">Quando `Cancel` viene chiamato su `CancellationTokenSource` , entrambe le voci della cache vengono eliminate.</span><span class="sxs-lookup"><span data-stu-id="1b778-343">When `Cancel` is called on the `CancellationTokenSource`, both cache entries are evicted.</span></span>

[!code-csharp[](memory/sample/WebCache/Controllers/HomeController.cs?name=snippet_ed)]

<span data-ttu-id="1b778-344">L'uso di un oggetto `CancellationTokenSource` consente di rimuovere più voci della cache come gruppo.</span><span class="sxs-lookup"><span data-stu-id="1b778-344">Using a `CancellationTokenSource` allows multiple cache entries to be evicted as a group.</span></span> <span data-ttu-id="1b778-345">Con il `using` modello nel codice precedente, le voci della cache create all'interno del `using` blocco erediteranno i trigger e le impostazioni di scadenza.</span><span class="sxs-lookup"><span data-stu-id="1b778-345">With the `using` pattern in the code above, cache entries created inside the `using` block will inherit triggers and expiration settings.</span></span>

## <a name="additional-notes"></a><span data-ttu-id="1b778-346">Note aggiuntive</span><span class="sxs-lookup"><span data-stu-id="1b778-346">Additional notes</span></span>

* <span data-ttu-id="1b778-347">Quando si usa un callback per ripopolare un elemento della cache:</span><span class="sxs-lookup"><span data-stu-id="1b778-347">When using a callback to repopulate a cache item:</span></span>

  * <span data-ttu-id="1b778-348">Più richieste possono trovare il valore della chiave memorizzato nella cache perché il callback non è stato completato.</span><span class="sxs-lookup"><span data-stu-id="1b778-348">Multiple requests can find the cached key value empty because the callback hasn't completed.</span></span>
  * <span data-ttu-id="1b778-349">Questo può comportare la ricompilazione dell'elemento memorizzato nella cache da parte di più thread.</span><span class="sxs-lookup"><span data-stu-id="1b778-349">This can result in several threads repopulating the cached item.</span></span>

* <span data-ttu-id="1b778-350">Quando viene utilizzata una voce della cache per crearne un'altra, l'elemento figlio copia i token di scadenza della voce padre e le impostazioni di scadenza basate sul tempo.</span><span class="sxs-lookup"><span data-stu-id="1b778-350">When one cache entry is used to create another, the child copies the parent entry's expiration tokens and time-based expiration settings.</span></span> <span data-ttu-id="1b778-351">L'elemento figlio non è scaduto dalla rimozione manuale o dall'aggiornamento della voce padre.</span><span class="sxs-lookup"><span data-stu-id="1b778-351">The child isn't expired by manual removal or updating of the parent entry.</span></span>

* <span data-ttu-id="1b778-352">Utilizzare [PostEvictionCallbacks](/dotnet/api/microsoft.extensions.caching.memory.icacheentry.postevictioncallbacks#Microsoft_Extensions_Caching_Memory_ICacheEntry_PostEvictionCallbacks) per impostare i callback che verranno generati dopo la rimozione della voce della cache dalla cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-352">Use [PostEvictionCallbacks](/dotnet/api/microsoft.extensions.caching.memory.icacheentry.postevictioncallbacks#Microsoft_Extensions_Caching_Memory_ICacheEntry_PostEvictionCallbacks) to set the callbacks that will be fired after the cache entry is evicted from the cache.</span></span>

## <a name="background-cache-update"></a><span data-ttu-id="1b778-353">Aggiornamento della cache in background</span><span class="sxs-lookup"><span data-stu-id="1b778-353">Background cache update</span></span>

<span data-ttu-id="1b778-354">Usare un [servizio in background](xref:fundamentals/host/hosted-services) , ad esempio <xref:Microsoft.Extensions.Hosting.IHostedService> per aggiornare la cache.</span><span class="sxs-lookup"><span data-stu-id="1b778-354">Use a [background service](xref:fundamentals/host/hosted-services) such as <xref:Microsoft.Extensions.Hosting.IHostedService> to update the cache.</span></span> <span data-ttu-id="1b778-355">Il servizio in background può ricalcolare le voci e quindi assegnarle alla cache solo quando sono pronte.</span><span class="sxs-lookup"><span data-stu-id="1b778-355">The background service can recompute the entries and then assign them to the cache only when they’re ready.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="1b778-356">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="1b778-356">Additional resources</span></span>

* <xref:performance/caching/distributed>
* <xref:fundamentals/change-tokens>
* <xref:performance/caching/response>
* <xref:performance/caching/middleware>
* <xref:mvc/views/tag-helpers/builtin-th/cache-tag-helper>
* <xref:mvc/views/tag-helpers/builtin-th/distributed-cache-tag-helper>

::: moniker-end
