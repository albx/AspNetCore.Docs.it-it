---
title: Controllo delle versioni dei servizi gRPC
author: jamesnk
description: Informazioni su come eseguire la versione dei servizi gRPC.
monikerRange: '>= aspnetcore-3.0'
ms.author: jamesnk
ms.date: 01/09/2020
uid: grpc/versioning
ms.openlocfilehash: 61dd5dfca4064af3ae58ac288a1ee636450ff56b
ms.sourcegitcommit: 79850db9e79b1705b89f466c6f2c961ff15485de
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 01/07/2020
ms.locfileid: "75694208"
---
# <a name="versioning-grpc-services"></a><span data-ttu-id="596e3-103">Controllo delle versioni dei servizi gRPC</span><span class="sxs-lookup"><span data-stu-id="596e3-103">Versioning gRPC services</span></span>

<span data-ttu-id="596e3-104">Di [James Newton-King](https://twitter.com/jamesnk)</span><span class="sxs-lookup"><span data-stu-id="596e3-104">By [James Newton-King](https://twitter.com/jamesnk)</span></span>

<span data-ttu-id="596e3-105">Le nuove funzionalità aggiunte a un'app possono richiedere i servizi gRPC forniti ai client da modificare, a volte in modi imprevisti e di interruzioni.</span><span class="sxs-lookup"><span data-stu-id="596e3-105">New features added to an app can require gRPC services provided to clients to change, sometimes in unexpected and breaking ways.</span></span> <span data-ttu-id="596e3-106">Quando i servizi gRPC cambiano:</span><span class="sxs-lookup"><span data-stu-id="596e3-106">When gRPC services change:</span></span>

* <span data-ttu-id="596e3-107">È necessario considerare il modo in cui le modifiche influiscano sui client.</span><span class="sxs-lookup"><span data-stu-id="596e3-107">Consideration should be given on how changes impact clients.</span></span>
* <span data-ttu-id="596e3-108">È necessario implementare una strategia di controllo delle versioni per supportare le modifiche.</span><span class="sxs-lookup"><span data-stu-id="596e3-108">A versioning strategy to support changes should be implemented.</span></span>

## <a name="backwards-compatibility"></a><span data-ttu-id="596e3-109">Compatibilità con le versioni precedenti</span><span class="sxs-lookup"><span data-stu-id="596e3-109">Backwards compatibility</span></span>

<span data-ttu-id="596e3-110">Il protocollo gRPC è progettato per supportare servizi che cambiano nel tempo.</span><span class="sxs-lookup"><span data-stu-id="596e3-110">The gRPC protocol is designed to support services that change over time.</span></span> <span data-ttu-id="596e3-111">In genere, le aggiunte ai servizi e ai metodi gRPC sono senza interruzioni.</span><span class="sxs-lookup"><span data-stu-id="596e3-111">Generally additions to gRPC services and methods are non-breaking.</span></span> <span data-ttu-id="596e3-112">L'assenza di interruzioni significa che i client esistenti continuano a funzionare.</span><span class="sxs-lookup"><span data-stu-id="596e3-112">Non-breaking means existing clients continue to work.</span></span> <span data-ttu-id="596e3-113">La modifica o l'eliminazione dei servizi gRPC sono modifiche di rilievo.</span><span class="sxs-lookup"><span data-stu-id="596e3-113">Changing or deleting gRPC services are breaking changes.</span></span> <span data-ttu-id="596e3-114">Le modifiche di rilievo indicano un errore dei client esistenti.</span><span class="sxs-lookup"><span data-stu-id="596e3-114">Breaking changes mean existing clients fail.</span></span>

<span data-ttu-id="596e3-115">Apportare modifiche non di rilievo a un servizio presenta diversi vantaggi:</span><span class="sxs-lookup"><span data-stu-id="596e3-115">Making non-breaking changes to a service has a number of benefits:</span></span>

- <span data-ttu-id="596e3-116">I client esistenti continuano a essere eseguiti.</span><span class="sxs-lookup"><span data-stu-id="596e3-116">Existing clients continue to run.</span></span>
- <span data-ttu-id="596e3-117">Evita il lavoro necessario per notificare ai client le modifiche di rilievo e aggiornarle.</span><span class="sxs-lookup"><span data-stu-id="596e3-117">Avoids work involved with notifying clients of breaking changes, and updating them.</span></span>
- <span data-ttu-id="596e3-118">Solo una versione del servizio deve essere documentata e mantenuta.</span><span class="sxs-lookup"><span data-stu-id="596e3-118">Only one version of the service needs to be documented and maintained.</span></span>

<span data-ttu-id="596e3-119">Questo contenuto è incentrato sulla possibilità di **suddividere le modifiche a un protocollo gRPC e a un livello di compatibilità binaria .NET**.</span><span class="sxs-lookup"><span data-stu-id="596e3-119">This content focuses on whether changes are **breaking at a gRPC protocol and .NET binary compatibility level**.</span></span> <span data-ttu-id="596e3-120">Quando si apportano modifiche, valutare se i client meno recenti possono continuare a lavorare logicamente.</span><span class="sxs-lookup"><span data-stu-id="596e3-120">When making changes, consider whether older clients can logically continue working.</span></span> <span data-ttu-id="596e3-121">Ad esempio, l'aggiunta di un nuovo campo a un messaggio di richiesta:</span><span class="sxs-lookup"><span data-stu-id="596e3-121">For example, adding a new field to a request message:</span></span>

* <span data-ttu-id="596e3-122">Non è una modifica di rilievo del protocollo.</span><span class="sxs-lookup"><span data-stu-id="596e3-122">Is not a protocol breaking change.</span></span>
* <span data-ttu-id="596e3-123">Se il nuovo campo non è impostato, la restituzione di uno stato di errore nel server rende una modifica di rilievo per i client obsoleti.</span><span class="sxs-lookup"><span data-stu-id="596e3-123">Returning an error status on the server if the new field is not set makes it a breaking change for old clients.</span></span>

### <a name="non-breaking-changes"></a><span data-ttu-id="596e3-124">Modifiche che non causano un'interruzione</span><span class="sxs-lookup"><span data-stu-id="596e3-124">Non-breaking changes</span></span>

<span data-ttu-id="596e3-125">Queste modifiche sono senza interruzioni a livello di protocollo gRPC e a livello binario .NET.</span><span class="sxs-lookup"><span data-stu-id="596e3-125">These changes are non-breaking at a gRPC protocol level, and .NET binary level.</span></span>

- <span data-ttu-id="596e3-126">**Aggiunta di un nuovo servizio**</span><span class="sxs-lookup"><span data-stu-id="596e3-126">**Adding a new service**</span></span>
- <span data-ttu-id="596e3-127">**Aggiunta di un nuovo metodo a un servizio**</span><span class="sxs-lookup"><span data-stu-id="596e3-127">**Adding a new method to a service**</span></span>
- <span data-ttu-id="596e3-128">L' **aggiunta di un campo a un messaggio di richiesta** -i campi aggiunti a un messaggio di richiesta vengono deserializzati con il [valore predefinito](https://developers.google.com/protocol-buffers/docs/proto3#default) nel server quando non è impostato.</span><span class="sxs-lookup"><span data-stu-id="596e3-128">**Adding a field to a request message** - Fields added to a request message are deserialized with the [default value](https://developers.google.com/protocol-buffers/docs/proto3#default) on the server when not set.</span></span> <span data-ttu-id="596e3-129">Per evitare interruzioni, il servizio dovrà avere esito positivo se non è impostato dai client meno recenti.</span><span class="sxs-lookup"><span data-stu-id="596e3-129">To be non-breaking the service will need to succeed when it is not set by older clients.</span></span>
- <span data-ttu-id="596e3-130">L' **aggiunta di un campo a un messaggio di risposta** : i campi aggiunti a un messaggio di risposta vengono deserializzati nella raccolta di [campi sconosciuti](https://developers.google.com/protocol-buffers/docs/proto3#unknowns) del messaggio nel client.</span><span class="sxs-lookup"><span data-stu-id="596e3-130">**Adding a field to a response message** - Fields added to a response message are deserialized into the message's [unknown fields](https://developers.google.com/protocol-buffers/docs/proto3#unknowns) collection on the client.</span></span>
- <span data-ttu-id="596e3-131">L' **aggiunta di un valore a** enum-enums viene serializzata come valore numerico.</span><span class="sxs-lookup"><span data-stu-id="596e3-131">**Adding a value to an enum** - Enums are serialized as a numeric value.</span></span> <span data-ttu-id="596e3-132">I nuovi valori enum vengono deserializzati nel client nel valore enum senza nome enum.</span><span class="sxs-lookup"><span data-stu-id="596e3-132">New enum values are deserialized on the client to the enum value without an enum name.</span></span> <span data-ttu-id="596e3-133">Per essere i client meno recenti devono essere eseguiti correttamente quando ricevono un valore diverso da quello di.</span><span class="sxs-lookup"><span data-stu-id="596e3-133">To be non-breaking older clients will need to run correctly when they receive and unexcepted value.</span></span>

### <a name="binary-breaking-changes"></a><span data-ttu-id="596e3-134">Modifiche di rilievo binarie</span><span class="sxs-lookup"><span data-stu-id="596e3-134">Binary breaking changes</span></span>

<span data-ttu-id="596e3-135">Le modifiche seguenti non sono in fase di suddivisione a livello di protocollo gRPC, ma il client deve essere aggiornato se esegue l'aggiornamento al contratto *. proto* più recente o all'assembly .NET del client.</span><span class="sxs-lookup"><span data-stu-id="596e3-135">The following changes are non-breaking at a gRPC protocol level, but the client needs to be updated if it upgrades to the latest *.proto* contract or client .NET assembly.</span></span> <span data-ttu-id="596e3-136">La compatibilità binaria è importante se si prevede di pubblicare una libreria gRPC in NuGet.</span><span class="sxs-lookup"><span data-stu-id="596e3-136">Binary compatibility is important if you plan to publish a gRPC library to NuGet.</span></span>

- <span data-ttu-id="596e3-137">La **rimozione di un** valore di campo da un campo rimosso viene deserializzata [nei campi sconosciuti](https://developers.google.com/protocol-buffers/docs/proto3#unknowns)di un messaggio.</span><span class="sxs-lookup"><span data-stu-id="596e3-137">**Removing a field** - Values from a removed field are deserialized to a message's [unknown fields](https://developers.google.com/protocol-buffers/docs/proto3#unknowns).</span></span> <span data-ttu-id="596e3-138">Non si tratta di una modifica di rilievo del protocollo gRPC, ma il client deve essere aggiornato in caso di aggiornamento al contratto più recente.</span><span class="sxs-lookup"><span data-stu-id="596e3-138">This isn't a gRPC protocol breaking change, but the client needs to be updated if it upgrades to the latest contract.</span></span> <span data-ttu-id="596e3-139">È importante che un numero di campo rimosso non venga accidentalmente riutilizzato in futuro.</span><span class="sxs-lookup"><span data-stu-id="596e3-139">It is important that a removed field number isn't accidentally reused in the future.</span></span> <span data-ttu-id="596e3-140">Un modo per assicurarsi che non si verifichi questo problema consiste nel specificare i nomi e i numeri di campo eliminati nel messaggio usando la parola chiave [`reserved`](https://developers.google.com/protocol-buffers/docs/proto3#reserved) di protobuf.</span><span class="sxs-lookup"><span data-stu-id="596e3-140">One way to make sure this doesn't happen is to specify deleted field numbers and names on the message using Protobuf's [`reserved`](https://developers.google.com/protocol-buffers/docs/proto3#reserved) keyword.</span></span>
- <span data-ttu-id="596e3-141">**La ridenominazione di un** campo-i nomi dei campi vengono utilizzati solo nel codice generato.</span><span class="sxs-lookup"><span data-stu-id="596e3-141">**Renaming a field** - Field names are only used in generated code.</span></span> <span data-ttu-id="596e3-142">Il numero di campo viene usato per identificare i campi sulla rete.</span><span class="sxs-lookup"><span data-stu-id="596e3-142">The field number is used to identify fields on the network.</span></span> <span data-ttu-id="596e3-143">Il client dovrà essere aggiornato in caso di aggiornamento al contratto più recente.</span><span class="sxs-lookup"><span data-stu-id="596e3-143">The client will need to be updated if it upgrades to the latest contract.</span></span>
- <span data-ttu-id="596e3-144">**Ridenominazione di un messaggio** : i nomi dei messaggi non vengono inviati sulla rete, quindi non si tratta di una modifica di rilievo del protocollo gRPC, ma il client deve essere aggiornato se viene aggiornato al contratto più recente.</span><span class="sxs-lookup"><span data-stu-id="596e3-144">**Renaming a message** - Message names are not sent on the network so this isn't a gRPC protocol breaking change, but the client will need to be updated if it upgrades to the latest contract.</span></span>
- <span data-ttu-id="596e3-145">Se si **modifica csharp_namespace** `csharp_namespace` cambiano lo spazio dei nomi dei tipi .NET generati.</span><span class="sxs-lookup"><span data-stu-id="596e3-145">**Changing csharp_namespace** - Changing `csharp_namespace` will change the namespace of generated .NET types.</span></span> <span data-ttu-id="596e3-146">Non si tratta di una modifica di rilievo del protocollo gRPC, ma il client deve essere aggiornato in caso di aggiornamento al contratto più recente.</span><span class="sxs-lookup"><span data-stu-id="596e3-146">This isn't a gRPC protocol breaking change, but the client needs to be updated if it upgrades to the latest contract.</span></span>

### <a name="breaking-changes"></a><span data-ttu-id="596e3-147">Modifiche che causano un'interruzione</span><span class="sxs-lookup"><span data-stu-id="596e3-147">Breaking changes</span></span>

<span data-ttu-id="596e3-148">Si tratta di modifiche di protocollo e di rilievo binarie.</span><span class="sxs-lookup"><span data-stu-id="596e3-148">These are protocol and binary breaking changes.</span></span>

- <span data-ttu-id="596e3-149">**Modifica del tipo di dati** di un campo: la modifica del tipo di dati di un campo in un [tipo incompatibile](https://developers.google.com/protocol-buffers/docs/proto3#updating) provocherà errori durante la deserializzazione del messaggio.</span><span class="sxs-lookup"><span data-stu-id="596e3-149">**Changing a field data type** - Changing a field's data type to an [incompatible type](https://developers.google.com/protocol-buffers/docs/proto3#updating) will cause errors when deserializing the message.</span></span> <span data-ttu-id="596e3-150">Anche se il nuovo tipo di dati è compatibile, è probabile che il client debba essere aggiornato per supportare il nuovo tipo se si aggiorna al contratto più recente.</span><span class="sxs-lookup"><span data-stu-id="596e3-150">Even if the new data type is compatible, it is likely the client will need to be updated to support the new type if it upgrades to the latest contract.</span></span>
- <span data-ttu-id="596e3-151">**Modifica di un numero di campo** : il numero di campo viene usato per identificare i campi sulla rete.</span><span class="sxs-lookup"><span data-stu-id="596e3-151">**Changing a field number** - The field number is used to identify fields on the network.</span></span>
- <span data-ttu-id="596e3-152">La **ridenominazione di un pacchetto, di un servizio o di un metodo** -gRPC usa il nome del pacchetto, il nome del servizio e il nome del metodo per compilare l'URL.</span><span class="sxs-lookup"><span data-stu-id="596e3-152">**Renaming a package, service or method** - gRPC uses the package name, service name and method name to build the URL.</span></span> <span data-ttu-id="596e3-153">Il client ottiene uno stato non *implementato* dal server.</span><span class="sxs-lookup"><span data-stu-id="596e3-153">The client gets an *UNIMPLEMENTED* status from the server.</span></span>
- <span data-ttu-id="596e3-154">**Rimozione di un servizio o di un metodo** : il client ottiene uno stato non *implementato* dal server quando viene chiamato il metodo rimosso.</span><span class="sxs-lookup"><span data-stu-id="596e3-154">**Removing a service or method** - The client gets an *UNIMPLEMENTED* status from the server when calling the removed method.</span></span>

## <a name="version-number-services"></a><span data-ttu-id="596e3-155">Servizi del numero di versione</span><span class="sxs-lookup"><span data-stu-id="596e3-155">Version number services</span></span>

<span data-ttu-id="596e3-156">I servizi devono rimanere compatibili con le versioni precedenti dei client.</span><span class="sxs-lookup"><span data-stu-id="596e3-156">Services should strive to remain backwards compatible with old clients.</span></span> <span data-ttu-id="596e3-157">Alla fine, le modifiche apportate all'app potrebbero richiedere modifiche di rilievo.</span><span class="sxs-lookup"><span data-stu-id="596e3-157">Eventually changes to your app may require breaking changes.</span></span> <span data-ttu-id="596e3-158">Suddividere i client obsoleti e forzarli a essere aggiornati insieme al servizio non è un'esperienza utente ottimale.</span><span class="sxs-lookup"><span data-stu-id="596e3-158">Breaking old clients and forcing them to be updated along with your service isn't a good user experience.</span></span> <span data-ttu-id="596e3-159">Un modo per mantenere la compatibilità con le versioni precedenti durante l'esecuzione di modifiche di rilievo consiste nel pubblicare più versioni di un servizio.</span><span class="sxs-lookup"><span data-stu-id="596e3-159">A way to maintain backwards compatibility while making breaking changes is to publish multiple versions of a service.</span></span>

<span data-ttu-id="596e3-160">gRPC supporta un identificatore [`package`](https://developers.google.com/protocol-buffers/docs/proto3#packages) facoltativo, che funziona in modo molto simile a uno spazio dei nomi .NET.</span><span class="sxs-lookup"><span data-stu-id="596e3-160">gRPC supports an optional [`package`](https://developers.google.com/protocol-buffers/docs/proto3#packages) specifier, which functions much like a .NET namespace.</span></span> <span data-ttu-id="596e3-161">Infatti, il `package` verrà utilizzato come spazio dei nomi .NET per i tipi .NET generati se `option csharp_namespace` non è impostato nel file con *estensione proto* .</span><span class="sxs-lookup"><span data-stu-id="596e3-161">In fact the `package` will be used as the .NET namespace for generated .NET types if `option csharp_namespace` is not set in the *.proto* file.</span></span> <span data-ttu-id="596e3-162">Il pacchetto può essere usato per specificare un numero di versione per il servizio e i relativi messaggi:</span><span class="sxs-lookup"><span data-stu-id="596e3-162">The package can be used to specify a version number for your service and its messages:</span></span>

[!code-protobuf[](versioning/sample/greet.v1.proto?highlight=3)]

<span data-ttu-id="596e3-163">Il nome del pacchetto viene combinato con il nome del servizio per identificare un indirizzo del servizio.</span><span class="sxs-lookup"><span data-stu-id="596e3-163">The package name is combined with the service name to identify a service address.</span></span> <span data-ttu-id="596e3-164">Un indirizzo del servizio consente l'hosting side-by-side di più versioni di un servizio:</span><span class="sxs-lookup"><span data-stu-id="596e3-164">A service address allows multiple versions of a service to be hosted side-by-side:</span></span>

* `greet.v1.Greeter`
* `greet.v2.Greeter`

<span data-ttu-id="596e3-165">Le implementazioni del servizio con versione sono registrate in *Startup.cs*:</span><span class="sxs-lookup"><span data-stu-id="596e3-165">Implementations of the versioned service are registered in *Startup.cs*:</span></span>

```csharp
app.UseEndpoints(endpoints =>
{
    // Implements greet.v1.Greeter
    endpoints.MapGrpcService<GreeterServiceV1>();

    // Implements greet.v2.Greeter
    endpoints.MapGrpcService<GreeterServiceV2>();
});
```

<span data-ttu-id="596e3-166">L'inclusione di un numero di versione nel nome del pacchetto consente di pubblicare una versione *v2* del servizio con modifiche di rilievo, continuando a supportare i client meno recenti che chiamano la versione *V1* .</span><span class="sxs-lookup"><span data-stu-id="596e3-166">Including a version number in the package name gives you the opportunity to publish a *v2* version of your service with breaking changes, while continuing to support older clients who call the *v1* version.</span></span> <span data-ttu-id="596e3-167">Dopo che i client sono stati aggiornati per l'uso del servizio *v2* , è possibile scegliere di rimuovere la versione precedente.</span><span class="sxs-lookup"><span data-stu-id="596e3-167">Once clients have updated to use the *v2* service you can choose to remove the old version.</span></span> <span data-ttu-id="596e3-168">Quando si pianifica la pubblicazione di più versioni di un servizio:</span><span class="sxs-lookup"><span data-stu-id="596e3-168">When planning to publish multiple versions of a service:</span></span>

- <span data-ttu-id="596e3-169">Evitare modifiche di rilievo se ragionevole.</span><span class="sxs-lookup"><span data-stu-id="596e3-169">Avoid breaking changes if reasonable.</span></span>
- <span data-ttu-id="596e3-170">Non aggiornare il numero di versione a meno che non vengano apportate modifiche di rilievo.</span><span class="sxs-lookup"><span data-stu-id="596e3-170">Don't update the version number unless making breaking changes.</span></span>
- <span data-ttu-id="596e3-171">Aggiornare il numero di versione quando si apportano modifiche di rilievo.</span><span class="sxs-lookup"><span data-stu-id="596e3-171">Do update the version number when you make breaking changes.</span></span>

<span data-ttu-id="596e3-172">La pubblicazione di più versioni di un servizio la Duplica.</span><span class="sxs-lookup"><span data-stu-id="596e3-172">Publishing multiple versions of a service duplicates it.</span></span> <span data-ttu-id="596e3-173">Per ridurre la duplicazione, provare a trasferire la logica di business dalle implementazioni del servizio a una posizione centralizzata che può essere riutilizzata dalle implementazioni precedenti e nuove:</span><span class="sxs-lookup"><span data-stu-id="596e3-173">To reduce duplication, consider moving business logic from the service implementations to a centralized location that can be reused by the old and new implementations:</span></span>

[!code-csharp[](versioning/sample/GreeterServiceV1.cs?highlight=10,19)]

<span data-ttu-id="596e3-174">I servizi e i messaggi generati con nomi di pacchetti diversi sono **tipi .NET diversi**.</span><span class="sxs-lookup"><span data-stu-id="596e3-174">Services and messages generated with different package names are **different .NET types**.</span></span> <span data-ttu-id="596e3-175">Per lo spostamento della logica di business in una posizione centralizzata è necessario eseguire il mapping dei messaggi ai tipi comuni.</span><span class="sxs-lookup"><span data-stu-id="596e3-175">Moving business logic to a centralized location requires mapping messages to common types.</span></span>
